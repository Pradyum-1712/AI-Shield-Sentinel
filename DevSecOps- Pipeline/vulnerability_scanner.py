import subprocess
import os
import json

def run_step(title, command):
    print(f"\n--- ğŸ›¡ï¸ RUNNING: {title} ---")
    try:
        result = subprocess.run(command, capture_output=True, text=True, shell=True)
        return result.stdout
    except Exception as e:
        return f"Error: {str(e)}"

def start_pipeline():
    # 1. Static Analysis Security Testing (SAST) - Using Bandit
    print("ğŸ” Step 1: Scanning Python Code for Vulnerabilities...")
    sast_results = run_step("Bandit SAST", "bandit -r ../AI-Shield -f json")
    
    # 2. Container Image Scanning - Using Trivy

    print("ğŸ³ Step 2: Scanning Docker Image for Known CVEs...")
    container_results = run_step("Trivy Scan", "trivy image --severity HIGH,CRITICAL python:3.11-slim")

    # 3. Secret Detection
    
    print("ğŸ”‘ Step 3: Checking for Leaked Secrets...")
    secret_results = run_step("Trivy Secret Scan", "trivy fs --scanners secret ../AI-Shield")

    # Final Summary Report
    print("\n" + "="*40)
    print("ğŸš€ PIPELINE COMPLETE: SECURITY REPORT GENERATED")
    print("="*40)
    # This logic creates a mini summary
    if "CRITICAL" in container_results:
        print("ğŸš¨ ALERT: Critical CVEs found in your base image!")
    else:
        print("âœ… Base image security verified.")

if __name__ == "__main__":
    start_pipeline()